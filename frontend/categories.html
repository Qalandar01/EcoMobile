<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Category Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>

<div class="container my-4">
  <h2>Categories</h2>
  <button class="btn btn-dark mb-3" data-bs-toggle="modal" data-bs-target="#categoryModal">+ Add Category</button>
  <ul class="list-group" id="category-list"></ul>
</div>
<div class="modal fade" id="categoryModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Category</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="category-form">
          <input type="hidden" id="category-id"> <!-- Hidden input for ID -->
          <div class="mb-3">
            <label class="form-label">Category Name:</label>
            <input type="text" id="category-name" class="form-control" required>
          </div>
          <button type="submit" class="btn btn-dark">Save</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  const token = localStorage.getItem("token");
  axios.defaults.headers.common['Authorization'] = token;

  document.addEventListener("DOMContentLoaded", loadCategories);

  function loadCategories() {
    axios.get("http://localhost:8080/api/categoryWithProQuantity")
            .then(res => {
              console.log("API Response:", res.data);
              let categoryList = document.getElementById("category-list");
              categoryList.innerHTML = res.data.map(cat => `
          <li class="list-group-item d-flex justify-content-between align-items-center">
            ${cat.categoryName || "No Name"}
            <span class="badge bg-primary">${cat.productCount || 0}</span>
            <button class="btn btn-sm btn-warning ms-2" onclick="editCategory(${cat.categoryId}, '${cat.categoryName}')">Edit</button>
            <button class="btn btn-sm btn-danger ms-2" onclick="deleteCategory(${cat.categoryId})">Delete</button>
          </li>
        `).join('');
            })
            .catch(err => console.error("Error fetching categories:", err));
  }

  document.getElementById("category-form").addEventListener("submit", function (event) {
    event.preventDefault();
    let categoryId = document.getElementById("category-id").value;
    let categoryName = document.getElementById("category-name").value.trim();
    if (!categoryName) return alert("Category name is required!");

    if (categoryId) {
      // Update category
      axios.put(`http://localhost:8080/api/category/${categoryId}`, { name: categoryName })
              .then(() => {
                resetForm();
                loadCategories();
                bootstrap.Modal.getInstance(document.getElementById('categoryModal')).hide();
              })
              .catch(err => alert("Failed to update category!"));
    } else {
      // Create new category
      axios.post("http://localhost:8080/api/category", { name: categoryName })
              .then(() => {
                resetForm();
                loadCategories();
                bootstrap.Modal.getInstance(document.getElementById('categoryModal')).hide();
              })
              .catch(err => alert("Failed to save category!"));
    }
  });

  function editCategory(id, name) {
    document.getElementById("category-id").value = id;
    document.getElementById("category-name").value = name;
    let modal = new bootstrap.Modal(document.getElementById('categoryModal'));
    modal.show();
  }

  function deleteCategory(id) {
    if (!confirm("Are you sure?")) return;
    axios.delete(`http://localhost:8080/api/category/${id}`)
            .then(loadCategories)
            .catch(err => alert("Failed to delete category!"));
  }

  function resetForm() {
    document.getElementById("category-id").value = "";
    document.getElementById("category-name").value = "";
  }
</script>

</body>
</html>
