<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add / Edit Product</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>

<div class="container my-4">
    <h2 id="form-title" class="mb-4">Add Product</h2>
    <form id="product-form" enctype="multipart/form-data">
        <input type="hidden" id="product-id">
        <div class="mb-3">
            <label class="form-label">Product Name:</label>
            <input type="text" id="product-name" class="form-control" required>
        </div>
        <div class="mb-3">
            <label class="form-label">Price:</label>
            <input type="number" id="product-price" class="form-control" required>
        </div>
        <div class="mb-3">
            <label class="form-label">Category:</label>
            <select id="product-category" class="form-select" required></select>
        </div>
        <div class="mb-3">
            <label class="form-label">Description:</label>
            <textarea id="product-description" class="form-control" required></textarea>
        </div>
        <div class="mb-3">
            <label class="form-label">Brand:</label>
            <select id="product-brand" class="form-select" required>
                <option value="NIKE">Nike</option>
                <option value="ADIDAS">Adidas</option>
                <option value="POLO">Polo</option>
                <option value="PUMA">Puma</option>
                <option value="ASUS">Asus</option>
                <option value="SONY">Sony</option>
                <option value="SAMSUNG">Samsung</option>
                <option value="APPLE">Apple</option>
                <option value="ACER">Acer</option>
            </select>
        </div>
        <div class="mb-3">
            <label class="form-label">Product Images:</label>
            <input type="file" id="product-images" class="form-control" accept="image/*" multiple>
        </div>
        <button type="submit" class="btn btn-dark">Save Product</button>
        <a href="products.html" class="btn btn-secondary">Cancel</a>
    </form>
</div>

<script>
    function getAuthHeaders() {
        let token = localStorage.getItem("token");
        return token ? { headers: { Authorization: token } } : {};
    }

    function getCategories(selectedCategoryId = null) {
        axios.get("http://localhost:8080/api/category", getAuthHeaders())
            .then(res => {
                let categorySelect = document.getElementById("product-category");
                categorySelect.innerHTML = res.data.map(cat =>
                    `<option value="${cat.id}" ${selectedCategoryId == cat.id ? 'selected' : ''}>${cat.name}</option>`
                ).join('');
            })
            .catch(err => alert(`Error: ${err.response?.data?.message || err.message}`));
    }

    function getProductDetails() {
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get("id");

        if (productId) {
            document.getElementById("form-title").innerText = "Edit Product";
            document.getElementById("product-id").value = productId;

            axios.get(`http://localhost:8080/api/product/${productId}`, getAuthHeaders())
                .then(res => {
                    document.getElementById("product-name").value = res.data.name;
                    document.getElementById("product-price").value = res.data.price;
                    document.getElementById("product-description").value = res.data.description;
                    document.getElementById("product-brand").value = res.data.productBrand;
                    getCategories(res.data.categoryId);
                })
                .catch(err => alert(`Error: ${err.response?.data?.message || err.message}`));
        } else {
            getCategories();
        }
    }

    document.getElementById("product-form").addEventListener("submit", function(event) {
        event.preventDefault();

        let productId = document.getElementById("product-id").value;
        let formData = new FormData();
        formData.append("name", document.getElementById("product-name").value);
        formData.append("price", document.getElementById("product-price").value);
        formData.append("description", document.getElementById("product-description").value);
        formData.append("productBrand", document.getElementById("product-brand").value);
        formData.append("categoryId", document.getElementById("product-category").value);

        let images = document.getElementById("product-images").files;
        for (let i = 0; i < images.length; i++) {
            formData.append("images", images[i]);
        }

        if (productId) {
            axios.put(`http://localhost:8080/api/product/${productId}`, formData, getAuthHeaders())
                .then(() => {
                    alert("Product updated successfully!");
                    window.location.href = "products.html";
                })
                .catch(err => alert(`Error: ${err.response?.data?.message || err.message}`));
        } else {
            axios.post("http://localhost:8080/api/product", formData, getAuthHeaders())
                .then(() => {
                    alert("Product added successfully!");
                    window.location.href = "products.html";
                })
                .catch(err => alert(`Error: ${err.response?.data?.message || err.message}`));
        }
    });

    getProductDetails();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
