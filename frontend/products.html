<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>

<div class="container my-4">
    <h2>Products</h2>
    <a href="categories.html" class="btn btn-secondary mb-3">Manage Categories</a>
    <a href="add-product.html" class="btn btn-dark mb-3">+ Add Product</a>
    <div class="row" id="product-list"></div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const token = localStorage.getItem("token");
        if (!token) {
            alert("You are not authorized! Please log in.");
            window.location.href = "login.html";
            return;
        }

        axios.defaults.headers.common["Authorization"] = token;
        loadProducts();
    });

    function loadProducts() {
        const productList = document.getElementById("product-list");
        productList.innerHTML = "<p class='text-info'>Loading products...</p>";

        axios.get("http://localhost:8080/api/product")
            .then(res => {
                if (!res.data.length) {
                    productList.innerHTML = "<p class='text-danger'>No products found.</p>";
                    return;
                }
                productList.innerHTML = res.data.map(prod => {
                    let imageUrl = prod.attachment && prod.attachment.length > 0
                        ? `http://localhost:8080/api/file/${prod.attachment[0].id}`
                        : 'https://via.placeholder.com/150';

                    return `
                        <div class="col-sm-6 col-md-4 col-lg-3">
                            <div class="card p-2 mb-3">
                                <img src="${imageUrl}" class="card-img-top" alt="Product Image" style="height: 200px; object-fit: cover;">
                                <div class="card-body">
                                    <h5 class="card-title">${prod.name}</h5>
                                    <p class="card-text">${prod.description || "No description"}</p>
                                    <p class="card-text"><strong>Price:</strong> $${prod.price}</p>
                                    <p class="card-text"><strong>Brand:</strong> ${prod.productBrand || "Unknown"}</p>
                                    <a onclick="editProduct(${prod.id})" class="btn btn-primary btn-sm">Edit</a>
                                    <button class="btn btn-danger btn-sm" onclick="deleteProduct(${prod.id})">Delete</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            })
            .catch(err => {
                console.error("Error fetching products:", err);
                productList.innerHTML = `<p class="text-danger">Failed to load products.</p>`;
            });
    }

    function editProduct(id) {
        window.location.href = "add-product.html?id=" + id;
    }

    function deleteProduct(id) {
        if (!confirm("Are you sure?")) return;
        axios.delete(`http://localhost:8080/api/product/${id}`)
            .then(() => {
                alert("Product deleted successfully!");
                loadProducts();
            })
            .catch(err => alert("Failed to delete product!"));
    }
</script>

</body>
</html>
